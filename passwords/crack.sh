#!/bin/bash

ENABLED=1
SYSTEMLOC=registry/SYSTEM
DITLOC=Active\ Directory/ntds.dit
M=1000
HASHES=crackmepls.ntds

# Extract using gosecretsdump. this is from memory, please forgive if wrong syntax for my own tool.
gosecretsdump -system $SYSTEM -dit $DITLOC > $HASHES
if [ $ENABLED -eq 1 ]; then
        cat extracted.ntds | grep 'status=Enabled' > $HASHES
fi

#two small for first cuts
hashcat -O -m 1000 $HASHES /shared/wordlists/RealPasswords/4Top32Million.txt -r /shared/rules/medium-InsidePro-HashManager.rule --session firstcut1of8
hashcat -O -m 1000 $HASHES /shared/wordlists/camwords.txt -r /shared/rules/small-best64.rule --session bigger2of8

#usernames as input
if [ $M -eq 1000 ]; then
    cat extracted.ntds | cut -f 1 -d : | cut -f 2 -d \\ > temp_usernames.txt
    cat extracted.ntds | cut -f 1 -d : >> temp_usernames.txt
    cat extracted.ntds | cut -f 1 -d : | cut -f 1 -d \\ >> temp_usernames.txt
    cat temp_usernames.txt | cut -f 1 -d \$ > t2 ; mv t2 temp_usernames.txt
    sort -u temp_usernames.txt > usernames.txt
    rm temp_usernames.txt
    hashcat -O -m 1000 $HASHES usernames.txt -r /shared/rules/big-OneRuleToRuleThemAll.rule --session usernames3of8
fi 

# use cracked passwords to find MORE PASSWORDS
CRACKEDCOUNT=0
while [ $CRACKEDCOUNT -ne $(hashcat -m 1000 $HASHES --show | wc -l) ]; do
    CRACKEDCOUNT=$(hashcat -m 1000 $HASHES --show | wc -l)
    hashcat -m 1000 $HASHES --show | cut -f 2 -d : >> t_crackedwords
    cat t_crackedwords | sort -u > crackedwords
    hashcat -O -m 1000 $HASHES crackedwords -r /shared/rules/big-OneRuleToRuleThemAll.rule --session passwordception4of8
    #use prince too (will take longer, but will find weirder stuff)
    hashcat -m 1000 $HASHES --show | cut -f 2 -d : >> t_crackedwords
    cat t_crackedwords | sort -u > crackedwords
    /home/hashcat/prince/pp64.bin --pw-min 8 --elem-cnt-max 10 < crackedwords | hashcat -O -m 1000 $HASHES -r /shared/rules/big-OneRuleToRuleThemAll.rule --session passwordceptionprince5of8
done

#biggenist
hashcat -O -m 1000 $HASHES /shared/wordlists/camwords.txt -r /shared/rules/big-OneRuleToRuleThemAll.rule --session biggest6of8

#do the sneaky cracwords thing again
CRACKEDCOUNT=0
while [ $CRACKEDCOUNT -ne $(hashcat -m 1000 $HASHES --show | wc -l) ]; do
    CRACKEDCOUNT=$(hashcat -m 1000 $HASHES --show | wc -l)
    hashcat -m 1000 $HASHES --show | cut -f 2 -d : >> t_crackedwords
    cat t_crackedwords | sort -u > crackedwords
    hashcat -O -m 1000 $HASHES crackedwords -r /shared/rules/big-OneRuleToRuleThemAll.rule --session passwordception7of8
    #use prince too (will take longer, but will find weirder stuff)
    hashcat -m 1000 $HASHES --show | cut -f 2 -d : >> t_crackedwords
    cat t_crackedwords | sort -u > crackedwords
    /home/hashcat/prince/pp64.bin --pw-min 8 --elem-cnt-max 10 < crackedwords | hashcat -O -m 1000 $HASHES -r /shared/rules/big-OneRuleToRuleThemAll.rule --session passwordceptionprince8of8
done

# manual steps:
# view cracked passwords. Look for trends that might not have been picked up by rules