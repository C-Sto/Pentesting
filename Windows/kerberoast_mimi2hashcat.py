#!/usr/bin/env python2

#This is a script that will take mimikatz/empire kerberoast output one of your esteemed colleagues has given to you to crack
#but is in the wrong format for hashcat. It's super janky - and I'm not sure what to use for the realm when no domain is in the 
#SPN so I guess it isn't complete - but it took me from 0/100 to 95/100 so hopefully it helps you too?

import sys

if len(sys.argv) < 2:
    print "Need a filename pls"
    exit(1)
with open(sys.argv[1]) as f:
    content = f.readlines()
# you may also want to remove whitespace characters like `\n` at the end of each line
content = [x.strip() for x in content] 

#$krb5tgs$23$*user$realm$test/spn*$first16$restofhash
#pre + usr + "$" + realm + "$" + spn + "*$" + hsh
rset = 0
pre = "$krb5tgs$23$*"
usr = ""
realm = ""
spn = ""
hsh = ""
for x in content:
    # build hash info
    if "Hash" in x:
        print pre + usr + "$" + realm + "$" + spn + "*$" + hsh
        usr = ""
        realm = ""
        spn = ""
        hsh = ""
        rset = 1
        hsh = x[x.rfind(":")+1:]
    elif "SamAccountName" in x:
        usr = x[x.index(":")+2:]
        pass
    elif "DistinguishedName" in x:
        pass
    elif "ServicePrincipalName" in x:
        spn = x[x.index(":")+2:]
        # get realm I guess?
        sub = spn.split("/")[1].split(":")[0]
        if "." in sub:
            realm = sub[sub.index(".")+1:]
    elif "TicketByteHexStream" in x:
        pass
    else:
        hsh = hsh+ x

    rset = 0
    

